name: Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CI: true
  NODE_VERSION: "20"
  # Ensure electron-builder can "publish" safely even if publish is disabled.
  # (We also pass --publish never in scripts, but some paths still check GH_TOKEN presence.)
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write

jobs:
  prepare:
    name: prepare (lockfile sync)
    runs-on: ubuntu-latest
    outputs:
      lockfile_pushed: ${{ steps.lockfile.outputs.lockfile_pushed }}
    steps:
      - name: Checkout (PR head)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Checkout (non-PR)
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Detect lockfile presence
        id: lock
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            echo "has_lockfile=true" >> "$GITHUB_OUTPUT"
            echo "[info] package-lock.json found"
          else
            echo "has_lockfile=false" >> "$GITHUB_OUTPUT"
            echo "[warn] package-lock.json missing"
          fi

      - name: Show versions
        shell: bash
        run: |
          node -v
          npm -v

      - name: Generate lockfile safely (no scripts)
        shell: bash
        run: |
          set -euo pipefail
          npm install --package-lock-only --ignore-scripts

      - name: Commit lockfile if changed
        id: lockfile
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git status --porcelain
            git add package-lock.json package.json || true
            git commit -m "chore(ci): sync lockfile" || true
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              git push origin "HEAD:${{ github.event.pull_request.head.ref }}"
            else
              git push origin "HEAD:${{ github.ref_name }}"
            fi
            echo "lockfile_pushed=true" >> "$GITHUB_OUTPUT"
          else
            echo "lockfile_pushed=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: build (${{ matrix.os }})
    needs: prepare
    if: needs.prepare.outputs.lockfile_pushed != 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (with cache)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Show versions
        shell: bash
        run: |
          node -v
          npm -v

      - name: Install dependencies (deterministic, include dev)
        shell: bash
        run: |
          set -euo pipefail
          npm ci --include=dev

      - name: "Sanity check - xlsx must resolve"
        shell: bash
        run: |
          set -euo pipefail
          node -e "console.log('xlsx resolved to:', require.resolve('xlsx'))"

      - name: Normalize xlsx bundle path for sync script (if needed)
        shell: bash
        run: |
          set -euo pipefail
          node scripts/sync-xlsx.mjs

      - name: Build (pre-dist)
        shell: bash
        run: |
          set -euo pipefail
          npm run build

      - name: Build distribution
        shell: bash
        run: |
          set -euo pipefail
          npm run dist -- --publish never

      - name: List dist
        shell: bash
        run: |
          set -euo pipefail
          ls -la
          if [ -d dist ]; then
            echo "[dist]"
            ls -la dist
          else
            echo "[warn] dist directory not found"
          fi

      - name: Collect deliverables (app only)
        shell: bash
        run: |
          set -euo pipefail
          OUT_DIR="deliverables/${{ matrix.os }}"
          mkdir -p "$OUT_DIR"

          if [ ! -d dist ]; then
            echo "[warn] dist directory not found; nothing to collect"
          else
            case "${{ matrix.os }}" in
              macos-latest)
                shopt -s nullglob
                files=(dist/*.dmg)
                if [ ${#files[@]} -eq 0 ]; then
                  echo "[warn] no .dmg found; fallback to .zip"
                  files=(dist/*mac*.zip dist/*.zip)
                fi
                for f in "${files[@]}"; do
                  cp -v "$f" "$OUT_DIR/" || true
                done
                ;;

              windows-latest)
                shopt -s nullglob
                files=(dist/*Setup*.exe dist/*.exe)
                for f in "${files[@]}"; do
                  base="$(basename "$f")"
                  case "$base" in
                    *unins*|*uninstaller*) continue ;;
                  esac
                  cp -v "$f" "$OUT_DIR/" || true
                done
                if [ -z "$(ls -A "$OUT_DIR" 2>/dev/null)" ]; then
                  echo "[warn] no .exe found; fallback to .zip"
                  files=(dist/*.zip)
                  for f in "${files[@]}"; do
                    cp -v "$f" "$OUT_DIR/" || true
                  done
                fi
                ;;

              *)
                echo "[warn] unknown OS matrix value: ${{ matrix.os }}"
                cp -v dist/* "$OUT_DIR/" || true
                ;;
            esac
          fi

          echo "[deliverables]"
          find deliverables -maxdepth 3 -type f -print -exec ls -lh {} \;

      - name: Upload artifacts (app only)
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.os }}
          path: deliverables/${{ matrix.os }}/**
          if-no-files-found: warn
