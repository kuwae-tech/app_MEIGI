name: Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  NODE_VERSION: "20"
  # Ensure electron-builder can "publish" safely even if publish is disabled.
  # (We also pass --publish never in scripts, but some paths still check GH_TOKEN presence.)
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect lockfile presence
        id: lock
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            echo "has_lockfile=true" >> "$GITHUB_OUTPUT"
            echo "[info] package-lock.json found"
          else
            echo "has_lockfile=false" >> "$GITHUB_OUTPUT"
            echo "[warn] package-lock.json missing"
          fi

      - name: Enforce lockfile presence
        if: steps.lock.outputs.has_lockfile != 'true'
        shell: bash
        run: |
          echo "::error ::package-lock.json がありません。package-lock.json をコミットして再実行してください。"
          exit 1

      - name: Setup Node (with cache)
        if: steps.lock.outputs.has_lockfile == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Node (no cache)
        if: steps.lock.outputs.has_lockfile != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Show versions
        shell: bash
        run: |
          node -v
          npm -v

      - name: Install dependencies (deterministic, include dev)
        shell: bash
        run: |
          set -euo pipefail
          if ! npm ci --include=dev; then
            echo "::error ::package-lock.json をコミットして再実行してください。"
            exit 1
          fi

      - name: Verify lockfile stayed clean
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error ::依存関係の不整合で lockfile 差分が発生しました。package-lock.json をコミットして再実行してください。"
            git status --porcelain
            exit 1
          fi

      - name: "Sanity check - xlsx must resolve"
        shell: bash
        run: |
          set -euo pipefail
          node -e "console.log('xlsx resolved to:', require.resolve('xlsx'))"

      - name: Normalize xlsx bundle path for sync script (if needed)
        shell: bash
        run: |
          set -euo pipefail
          node scripts/sync-xlsx.mjs

      - name: Build (pre-dist)
        shell: bash
        run: |
          set -euo pipefail
          npm run build

      - name: Build distribution
        shell: bash
        run: |
          set -euo pipefail
          npm run dist -- --publish never

      - name: List dist
        shell: bash
        run: |
          set -euo pipefail
          ls -la
          if [ -d dist ]; then
            echo "[dist]"
            ls -la dist
          else
            echo "[warn] dist directory not found"
          fi

      - name: Collect deliverables (app only)
        shell: bash
        run: |
          set -euo pipefail
          OUT_DIR="deliverables/${{ matrix.os }}"
          mkdir -p "$OUT_DIR"

          if [ ! -d dist ]; then
            echo "[warn] dist directory not found; nothing to collect"
          else
            case "${{ matrix.os }}" in
              macos-latest)
                shopt -s nullglob
                files=(dist/*.dmg)
                if [ ${#files[@]} -eq 0 ]; then
                  echo "[warn] no .dmg found; fallback to .zip"
                  files=(dist/*mac*.zip dist/*.zip)
                fi
                for f in "${files[@]}"; do
                  cp -v "$f" "$OUT_DIR/" || true
                done
                ;;

              windows-latest)
                shopt -s nullglob
                files=(dist/*Setup*.exe dist/*.exe)
                for f in "${files[@]}"; do
                  base="$(basename "$f")"
                  case "$base" in
                    *unins*|*uninstaller*) continue ;;
                  esac
                  cp -v "$f" "$OUT_DIR/" || true
                done
                if [ -z "$(ls -A "$OUT_DIR" 2>/dev/null)" ]; then
                  echo "[warn] no .exe found; fallback to .zip"
                  files=(dist/*.zip)
                  for f in "${files[@]}"; do
                    cp -v "$f" "$OUT_DIR/" || true
                  done
                fi
                ;;

              *)
                echo "[warn] unknown OS matrix value: ${{ matrix.os }}"
                cp -v dist/* "$OUT_DIR/" || true
                ;;
            esac
          fi

          echo "[deliverables]"
          find deliverables -maxdepth 3 -type f -print -exec ls -lh {} \;

      - name: Upload artifacts (app only)
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.os }}
          path: deliverables/${{ matrix.os }}/**
          if-no-files-found: warn
