name: Build

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

# electron-builder が publish 判定で token を要求するケースがあるため、
# GITHUB_TOKEN を使えるように permissions を明示（Artifactsのみ運用でも害なし）
permissions:
  contents: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    env:
      CI: true
      # electron-builder が token を要求するケース対策（publishはしないが要求だけされる事がある）
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # lockfile があるときだけ cache-dependency-path を有効化（Windows即死を避ける）
      - name: Setup Node (with cache when lockfile exists)
        if: ${{ hashFiles('package-lock.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Node (no cache when lockfile missing)
        if: ${{ hashFiles('package-lock.json') == '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Show versions
        run: |
          node -v
          npm -v

      - name: Ensure lockfile exists
        run: node -e "const fs=require('fs'); if(!fs.existsSync('package-lock.json')){ console.error('ERROR: package-lock.json is missing. Commit a lockfile to enable deterministic builds (npm ci).'); process.exit(1);} console.log('OK: package-lock.json exists');"

      # devDependencies も含めて入れる（sync-xlsx / build-vendor 等が dev に居ると死ぬのを防ぐ）
      - name: Install dependencies (deterministic)
        run: npm ci --include=dev

      - name: Sanity check - xlsx must resolve
        run: node -e "console.log('xlsx resolved to:', require.resolve('xlsx'))"

      # renderer/vendor/xlsx.full.min.js を用意（CDN依存回避）
      - name: Sync xlsx vendor bundle
        run: node scripts/sync-xlsx.mjs

      - name: Build (pre-dist)
        run: npm run build

      # publish は絶対しない（Artifacts のみ）
      - name: Build distribution (no publish)
        run: npm run dist -- --publish never

      - name: Debug dist outputs
        run: node -e "const fs=require('fs'); const p='dist'; console.log('dist exists:', fs.existsSync(p)); if(fs.existsSync(p)){ console.log('dist entries:', fs.readdirSync(p)); }"

      - name: Upload artifacts (dist)
        uses: actions/upload-artifact@v4
        with:
          name: app_MEIGI-${{ matrix.os }}-dist
          path: dist/**
          if-no-files-found: warn
